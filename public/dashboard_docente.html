<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Docente</title>
    <style>
        /* --- ESTILOS BASE --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 0; display: flex; color: #333; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background-color: #ffc107; color: #333; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); min-height: 100vh; position: sticky; top: 0; }
        .sidebar h3 { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e0a800; padding-bottom: 15px; font-weight: 700; }
        .sidebar a { display: block; color: #333; padding: 12px 15px; text-decoration: none; border-bottom: 1px solid #e0a800; transition: all 0.3s ease; border-radius: 4px; font-weight: 500; margin-bottom: 5px;}
        .sidebar a:hover { background-color: #fff8e1; padding-left: 20px; }

        /* --- CONTENIDO --- */
        .main-content { flex-grow: 1; padding: 30px; background-color: #f8f9fa; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .main-content h2 { color: #333; margin-bottom: 25px; font-size: 28px; border-bottom: 2px solid #ffc107; padding-bottom: 10px; display: inline-block; }

        /* --- SECCIONES --- */
        .section { background-color: #fff; padding: 25px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e9ecef; transition: transform 0.2s; }
        .section:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .section h3 { color: #d39e00; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; }
        
        /* --- INPUTS --- */
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; margin-top: 15px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="datetime-local"], textarea, select, input[type="file"] { 
            width: 100%; padding: 10px 12px; margin: 5px 0 15px 0; 
            border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; 
            font-size: 14px; transition: border-color 0.3s; 
        }
        input:focus, textarea:focus, select:focus { border-color: #ffc107; outline: none; }

        /* --- BOTONES --- */
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 5px; margin-top: 5px; transition: background 0.3s; }
        button:hover { background-color: #218838; transform: translateY(-1px); }
        button.cancel { background-color: #dc3545; }
        
        /* --- TABLAS --- */
        .styled-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.95em; font-family: sans-serif; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); border-radius: 8px; overflow: hidden; }
        .styled-table thead tr { background-color: #343a40; color: #ffffff; text-align: left; }
        .styled-table th, .styled-table td { padding: 15px; border-bottom: 1px solid #dddddd; text-align: center; } 
        .styled-table th:first-child, .styled-table td:first-child { text-align: left; font-weight: 600; }
        .styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
        .styled-table input[type="number"] { width: 70px; margin: 0 auto; text-align: center; display: inline-block; }
        .avg-display { font-weight: bold; color: #0056b3; font-size: 1.1em; }

        /* --- LISTAS Y SOLICITUDES --- */
        .request-list { list-style-type: none; padding: 0; }
        .request-list li { background-color: #fff; padding: 20px; border-left: 5px solid #17a2b8; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- CHAT --- */
        .chat-container { display: flex; height: 550px; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; background: #fff; }
        .chat-sidebar-list { width: 35%; background-color: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; }
        .chat-contact { padding: 15px; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background 0.2s; }
        .chat-contact:hover { background-color: #e2e6ea; }
        .chat-contact.active { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        
        .chat-area { width: 65%; display: flex; flex-direction: column; background-color: #fff; }
        .chat-header { padding: 15px; background: #f1f1f1; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #fafafa; }
        
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        /* Mensajes RECIBIDOS (Izquierda) */
        .message.received { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #eee; }
        /* Mensajes ENVIADOS (Derecha) */
        .message.sent { background-color: #d1e7dd; align-self: flex-end; border-bottom-right-radius: 4px; color: #0f5132; }
        
        .message-time { display: block; font-size: 0.75em; margin-top: 4px; text-align: right; opacity: 0.7; }
        
        .chat-input-area { padding: 20px; border-top: 1px solid #ddd; display: flex; background: #fff; gap: 10px; }
        .chat-input-area input { flex-grow: 1; margin: 0; border-radius: 25px; padding: 12px 20px; border: 1px solid #ccc; }
        .chat-input-area button { margin: 0; border-radius: 25px; padding: 0 30px; height: 42px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Docente</h3>
        <a href="#avisos">Publicar Avisos</a>
        <a href="#observaciones">Observaciones Alumnos</a>
        <a href="#calificaciones">Subir Calificaciones</a>
        <a href="#asistencias">Registrar Asistencias</a>
        <a href="#evidencias">Subir Evidencias</a>
        <a href="#citas">Gestionar Citas</a>
        <a href="#chat">Chat con Tutores</a>
        <a href="#" onclick="logout()">Cerrar Sesi칩n</a>
    </div>

    <div class="main-content">
        <h2 id="welcomeMessageDocente">Bienvenido, Docente</h2>

        <!-- AVISOS -->
        <div id="avisos" class="section">
            <h3>Publicar Avisos Generales</h3>
            <label><strong>T칤tulo del Aviso:</strong></label>
            <input type="text" id="txtTituloAviso" placeholder="Ej: Suspensi칩n de clases...">
            <label><strong>Contenido:</strong></label>
            <textarea id="txtContenidoAviso" rows="4" placeholder="Escriba aqu칤 el detalle del aviso..."></textarea>
            <button onclick="publicarAviso()">Publicar Aviso</button>
        </div>

        <!-- OBSERVACIONES -->
        <div id="observaciones" class="section">
            <h3>Subir Observaciones del Alumno</h3>
            <label><strong>Seleccionar Alumno:</strong></label>
            <select id="selAlumnoObs"><option value="">-- Selecciona un alumno --</option></select>
            <label><strong>T칤tulo:</strong></label>
            <input type="text" id="txtTituloObs" placeholder="Ej: Comportamiento...">
            <label><strong>Descripci칩n:</strong></label>
            <textarea id="txtDescObs" rows="3"></textarea>
            <label><strong>Fecha y Hora:</strong></label>
            <input type="datetime-local" id="observacionDate">
            <button onclick="guardarObservacion()">Guardar Observaci칩n</button>
        </div>

        <!-- CALIFICACIONES -->
        <div id="calificaciones" class="section">
            <h3>Subir Calificaciones</h3>
            <div style="margin-bottom: 15px;">
                <label><strong>Seleccionar Alumno:</strong></label>
                <select id="selectAlumnoGrade"><option value="">-- Cargando alumnos... --</option></select>
            </div>
            <table class="styled-table">
                <thead><tr><th>Materia</th><th>1er Parcial</th><th>2do Parcial</th><th>3er Parcial</th><th>Promedio</th><th>Acciones</th></tr></thead>
                <tbody id="gradesBody">
                    <tr><td><strong>Matem치ticas</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 1)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                    <tr><td><strong>Espa침ol</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 2)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                    <tr><td><strong>Ciencias</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 3)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ASISTENCIAS -->
        <div id="asistencias" class="section">
            <h3>Registrar Asistencias del D칤a</h3>
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                <label style="margin:0;">Fecha:</label>
                <input type="date" id="asistenciaFecha" style="width: auto; margin:0;">
            </div>
            
            <table class="styled-table" id="tablaAsistenciaMasiva">
                <thead>
                    <tr>
                        <th style="width: 40%;">Alumno</th>
                        <th style="width: 20%;">D칤a</th>
                        <th style="width: 40%;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3">Cargando lista de alumnos...</td></tr>
                </tbody>
            </table>
            <button onclick="guardarAsistenciaMasiva()">Guardar Todo</button>
        </div>

        <!-- EVIDENCIAS -->
        <div id="evidencias" class="section">
            <h3>游닝 Subir Evidencias de Clase</h3>
            <label><strong>Asignar a:</strong></label>
            <select id="selAlumnoEvidencia"><option value="all">Todo el Grupo</option></select>
            <label><strong>Materia:</strong></label>
            <select id="evidenciaMateria">
                <option value="1">Matem치ticas</option>
                <option value="2">Espa침ol</option>
                <option value="3">Ciencias</option>
            </select>
            <label><strong>T칤tulo de la Evidencia:</strong></label>
            <input type="text" id="txtTituloEvidencia" placeholder="Ej: Proyecto final...">
            <label><strong>Descripci칩n:</strong></label>
            <textarea id="txtDescEvidencia" rows="3" placeholder="Detalles de la tarea..."></textarea>
            <label><strong>Adjuntar Archivo (Foto/PDF):</strong></label>
            <input type="file" id="evidenciaFile">
            <button onclick="subirEvidencia()">游닋 Publicar Evidencia</button>
        </div>

        <!-- CITAS -->
        <div id="citas" class="section">
            <h3>Gestionar Citas</h3>
            <div style="margin-bottom: 30px;">
                <h4 style="color: #0056b3; border-bottom: 2px solid #e9ecef;">游댒 Solicitudes</h4>
                <ul class="request-list"><li>Cargando...</li></ul>
            </div>
        </div>

        <!-- CHAT -->
        <div id="chat" class="section">
            <h3>Mensajer칤a con Padres de Familia</h3>
            <div class="chat-container">
                <div class="chat-sidebar-list" id="listaTutoresChat">
                    <div style="padding:20px; color:#666;">Cargando contactos...</div>
                </div>
                <div class="chat-area">
                    <div class="chat-header" id="chatHeader">Selecciona un chat</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="msgInput" placeholder="Escriba un mensaje..." disabled>
                        <button onclick="sendMessage()" id="btnSend" disabled>Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        let currentChatTutorId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const userName = localStorage.getItem('loggedInUserName');
            const userId = localStorage.getItem('loggedInUserId'); 
            if (!userId) { window.location.href = 'login.html'; return; }
            if (userName) document.getElementById('welcomeMessageDocente').textContent = `Bienvenido, ${userName}`;

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            if(document.getElementById('asistenciaFecha')) document.getElementById('asistenciaFecha').value = dateStr;
            if(document.getElementById('observacionDate')) {
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('observacionDate').value = now.toISOString().slice(0, 16);
            }

            cargarAlumnos(userId);
            cargarCitasPendientes(userId);
            cargarListaTutoresParaChat(userId);
            
            setInterval(() => {
                if(currentChatTutorId) cargarMensajesChat(userId, currentChatTutorId);
            }, 5000);
        });

        // 1. CARGAR ALUMNOS
        async function cargarAlumnos(userId) {
            try {
                const res = await fetch(`/api/docente/alumnos/${userId}`);
                const alumnos = await res.json();
                
                const selects = [document.getElementById('selectAlumnoGrade'), document.getElementById('selAlumnoObs')];
                selects.forEach(sel => {
                    sel.innerHTML = '<option value="">-- Selecciona un alumno --</option>';
                    alumnos.forEach(al => {
                        const opt = document.createElement('option');
                        opt.value = al.ID_Alumno; opt.textContent = `${al.Nombre_Alumno}`; sel.appendChild(opt);
                    });
                });
                
                const selEvi = document.getElementById('selAlumnoEvidencia');
                selEvi.innerHTML = '<option value="all">Todo el Grupo</option>';
                alumnos.forEach(al => {
                    const opt = document.createElement('option'); opt.value = al.ID_Alumno; opt.textContent = al.Nombre_Alumno; selEvi.appendChild(opt);
                });

                const tablaAsis = document.querySelector('#tablaAsistenciaMasiva tbody');
                tablaAsis.innerHTML = '';
                if(alumnos.length === 0) {
                    tablaAsis.innerHTML = '<tr><td colspan="3">No hay alumnos asignados.</td></tr>';
                } else {
                    alumnos.forEach(al => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="text-align:left; padding-left:20px;">${al.Nombre_Alumno}</td>
                            <td class="fecha-celda">--</td> 
                            <td>
                                <select class="estado-asistencia" data-id-alumno="${al.ID_Alumno}">
                                    <option value="presente">Presente</option>
                                    <option value="retardo">Retardo</option>
                                    <option value="ausente">Ausente</option>
                                </select>
                            </td>
                        `;
                        tablaAsis.appendChild(tr);
                    });
                    actualizarFechaTabla();
                    document.getElementById('asistenciaFecha').addEventListener('change', actualizarFechaTabla);
                }
            } catch (e) { console.error(e); }
        }

        function actualizarFechaTabla() {
            const fecha = document.getElementById('asistenciaFecha').value;
            document.querySelectorAll('.fecha-celda').forEach(td => td.textContent = fecha);
        }

        // 2. PUBLICAR AVISOS (NUEVO)
        async function publicarAviso() {
            const titulo = document.getElementById('txtTituloAviso').value;
            const contenido = document.getElementById('txtContenidoAviso').value;
            if(!titulo || !contenido) return alert("Complete los campos del aviso");

            const res = await fetch('/api/docente/aviso', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ titulo, contenido, idUsuario: localStorage.getItem('loggedInUserId') })
            });
            const data = await res.json();
            if(data.success) {
                alert("Aviso publicado");
                document.getElementById('txtTituloAviso').value='';
                document.getElementById('txtContenidoAviso').value='';
            }
        }

        // 3. GUARDAR OBSERVACIONES (NUEVO)
        async function guardarObservacion() {
            const idAlumno = document.getElementById('selAlumnoObs').value;
            const titulo = document.getElementById('txtTituloObs').value;
            const desc = document.getElementById('txtDescObs').value;
            const fecha = document.getElementById('observacionDate').value;
            
            if(!idAlumno || !titulo) return alert("Seleccione alumno y t칤tulo");

            const res = await fetch('/api/docente/observacion', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ titulo, descripcion: desc, fecha, idAlumno, idUsuario: localStorage.getItem('loggedInUserId') })
            });
            const data = await res.json();
            if(data.success) {
                alert("Observaci칩n guardada");
                document.getElementById('txtTituloObs').value='';
                document.getElementById('txtDescObs').value='';
            }
        }

        // 4. EVIDENCIAS
        async function subirEvidencia() {
            const idAlumno = document.getElementById('selAlumnoEvidencia').value;
            const idMateria = document.getElementById('evidenciaMateria').value;
            const titulo = document.getElementById('txtTituloEvidencia').value;
            const desc = document.getElementById('txtDescEvidencia').value;
            const fileInput = document.getElementById('evidenciaFile');

            if(!titulo) return alert("El t칤tulo es obligatorio");

            const formData = new FormData();
            formData.append('titulo', titulo);
            formData.append('descripcion', desc);
            formData.append('idMateria', idMateria);
            formData.append('idAlumno', idAlumno);
            if(fileInput.files.length > 0) formData.append('archivo', fileInput.files[0]);

            const res = await fetch('/api/docente/evidencia', { method: 'POST', body: formData });
            const data = await res.json();
            if(data.success) {
                alert("Evidencia publicada correctamente.");
                document.getElementById('txtTituloEvidencia').value='';
                document.getElementById('txtDescEvidencia').value='';
                fileInput.value = '';
            } else alert("Error: " + data.msg);
        }

        // 5. ASISTENCIAS
        window.guardarAsistenciaMasiva = async () => {
            const fecha = document.getElementById('asistenciaFecha').value;
            const selects = document.querySelectorAll('.estado-asistencia');
            if(!confirm(`쮾uardar asistencia para ${selects.length} alumnos?`)) return;
            for(const sel of selects) {
                await fetch('/api/docente/asistencia', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ fecha, estado: sel.value, idAlumno: sel.getAttribute('data-id-alumno') })
                });
            }
            alert("Asistencias guardadas.");
        };

        // 6. CALIFICACIONES
        window.calculateRow = function(input) { 
            const row = input.closest('tr'); const inputs = row.querySelectorAll('input[type="number"]');
            let s=0, c=0; inputs.forEach(i=>{if(i.value){s+=parseFloat(i.value); c++}});
            row.querySelector('.avg-display').textContent = c===3?(s/3).toFixed(1):"-";
        };
        window.guardarNota = async (boton, idMateria) => {
            const row = boton.closest('tr'); const inputs = row.querySelectorAll('input[type="number"]');
            const idAlumno = document.getElementById('selectAlumnoGrade').value;
            if (!idAlumno) return alert("Selecciona alumno");
            for (let i=0; i<3; i++) {
                if (inputs[i].value) {
                    await fetch('/api/docente/calificar', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ calificacion: inputs[i].value, parcial: (i+1).toString(), idAlumno, idMateria, idDocente: localStorage.getItem('loggedInUserId') })
                    });
                }
            }
            alert("Notas guardadas.");
        };

        // 7. CITAS
        async function cargarCitasPendientes(userId) {
            const lista = document.querySelector('.request-list');
            const res = await fetch(`/api/docente/citas-pendientes/${userId}`);
            const citas = await res.json();
            lista.innerHTML = '';
            if(citas.length === 0) { lista.innerHTML = '<li>No hay solicitudes pendientes.</li>'; return; }
            citas.forEach(cita => {
                const fecha = new Date(cita.FechaSolicitud_Cita).toLocaleDateString();
                const hora = cita.HoraSolicitada_Cita.substring(0,5);
                lista.innerHTML += `<li><strong>Tutor: ${cita.Nombre_Tutor}</strong><br>Solicita: ${fecha} - ${hora}<br><em>"${cita.Motivo_Cita}"</em><br><button onclick="responderCita(${cita.ID_Cita}, 'Confirmada')">Aceptar</button><button class="cancel" onclick="responderCita(${cita.ID_Cita}, 'Rechazada')">Rechazar</button></li>`;
            });
        }
        window.responderCita = async (idCita, estado) => {
            if(!confirm(`${estado} esta cita?`)) return;
            const fecha = new Date().toISOString().split('T')[0]; // Fecha actual de confirmaci칩n
            const hora = new Date().toTimeString().substring(0,5);
            await fetch('/api/docente/responder-cita', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idCita, estado, fecha, hora }) });
            alert("Cita actualizada"); cargarCitasPendientes(localStorage.getItem('loggedInUserId'));
        };

        // 8. CHAT MEJORADO (CON LOGICA WHATSAPP)
        async function cargarListaTutoresParaChat(userId) {
            const sidebar = document.getElementById('listaTutoresChat');
            const res = await fetch(`/api/docente/tutores/${userId}`); 
            const tutores = await res.json();
            sidebar.innerHTML = '';
            if(tutores.length === 0) sidebar.innerHTML = '<div style="padding:20px;">No hay tutores.</div>';
            tutores.forEach(t => {
                const div = document.createElement('div');
                div.className = 'chat-contact';
                div.innerHTML = `<strong>${t.Nombre_Tutor}</strong><br><small>${t.Nombre_Alumno}</small>`;
                div.onclick = () => abrirChat(t.ID_Tutor, t.Nombre_Tutor, div);
                sidebar.appendChild(div);
            });
        }

        function abrirChat(idTutor, nombreTutor, elementoDiv) {
            currentChatTutorId = idTutor;
            document.getElementById('chatHeader').textContent = `Chat con: ${nombreTutor}`;
            document.querySelectorAll('.chat-contact').forEach(d => d.classList.remove('active'));
            elementoDiv.classList.add('active');
            document.getElementById('msgInput').disabled = false;
            document.getElementById('btnSend').disabled = false;
            cargarMensajesChat(localStorage.getItem('loggedInUserId'), idTutor);
        }

        async function cargarMensajesChat(idDocente, idTutor) {
            const div = document.querySelector('.chat-messages');
            const res = await fetch('/api/chat/mensajes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idUsuario: idDocente, rol: 'Docente' }) });
            const todos = await res.json();
            
            // Filtrar solo los mensajes con este tutor espec칤fico
            const filtrados = todos.filter(m => m.ID_MnsjTutor == idTutor);

            div.innerHTML = '';
            filtrados.forEach(m => {
                const fecha = new Date(m.Fecha_Mnsj);
                const hora = fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // --- L칍GICA WHATSAPP ---
                // Si el mensaje fue enviado por 'Docente', es m칤o (derecha).
                // Si fue enviado por 'Tutor', es recibido (izquierda).
                const esMio = m.EnviadoPor === 'Docente';
                const clase = esMio ? 'sent' : 'received';

                div.innerHTML += `
                    <div class="message ${clase}">
                        ${m.Contenido_Mnsj}
                        <span class="message-time">${hora}</span>
                    </div>`;
            });
        }

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput');
            if(!inp.value || !currentChatTutorId) return;
            
            await fetch('/api/chat/enviar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    contenido: inp.value, 
                    idUsuario: localStorage.getItem('loggedInUserId'), 
                    rol: 'Docente', 
                    idDestinatario: currentChatTutorId 
                })
            });
            inp.value = '';
            cargarMensajesChat(localStorage.getItem('loggedInUserId'), currentChatTutorId);
        };

        window.logout = function() { localStorage.clear(); window.location.href='pagina inicio logo.html'; }
    </script>
</body>
</html>