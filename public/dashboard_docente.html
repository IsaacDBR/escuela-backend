<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Docente</title>
    <style>
        /* --- ESTILOS BASE --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 0; display: flex; color: #333; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background-color: #ffc107; color: #333; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); min-height: 100vh; position: sticky; top: 0; }
        .sidebar h3 { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e0a800; padding-bottom: 15px; font-weight: 700; }
        .sidebar a { display: block; color: #333; padding: 12px 15px; text-decoration: none; border-bottom: 1px solid #e0a800; transition: all 0.3s ease; border-radius: 4px; font-weight: 500; margin-bottom: 5px;}
        .sidebar a:hover { background-color: #fff8e1; padding-left: 20px; }

        /* --- CONTENIDO --- */
        .main-content { flex-grow: 1; padding: 30px; background-color: #f8f9fa; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .main-content h2 { color: #333; margin-bottom: 25px; font-size: 28px; border-bottom: 2px solid #ffc107; padding-bottom: 10px; display: inline-block; }

        /* --- SECCIONES --- */
        .section { background-color: #fff; padding: 25px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e9ecef; transition: transform 0.2s; }
        .section:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .section h3 { color: #d39e00; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; }
        
        /* --- INPUTS --- */
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; margin-top: 15px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="datetime-local"], textarea, select, input[type="file"] { 
            width: 100%; padding: 10px 12px; margin: 5px 0 15px 0; 
            border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; 
            font-size: 14px; transition: border-color 0.3s; 
        }
        input:focus, textarea:focus, select:focus { border-color: #ffc107; outline: none; }

        /* --- BOTONES --- */
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 5px; margin-top: 5px; transition: background 0.3s; }
        button:hover { background-color: #218838; transform: translateY(-1px); }
        button.cancel { background-color: #dc3545; }
        
        /* --- TABLAS --- */
        .styled-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.95em; font-family: sans-serif; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); border-radius: 8px; overflow: hidden; }
        .styled-table thead tr { background-color: #343a40; color: #ffffff; text-align: left; }
        .styled-table th, .styled-table td { padding: 15px; border-bottom: 1px solid #dddddd; text-align: center; } 
        .styled-table th:first-child, .styled-table td:first-child { text-align: left; font-weight: 600; }
        .styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
        .styled-table input[type="number"] { width: 70px; margin: 0 auto; text-align: center; display: inline-block; }
        .avg-display { font-weight: bold; color: #0056b3; font-size: 1.1em; }

        /* --- LISTAS Y SOLICITUDES --- */
        .request-list { list-style-type: none; padding: 0; }
        .request-list li { background-color: #fff; padding: 20px; border-left: 5px solid #17a2b8; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- CHAT --- */
        .chat-container { display: flex; height: 550px; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; background: #fff; }
        .chat-sidebar-list { width: 35%; background-color: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; }
        .chat-contact { padding: 15px; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background 0.2s; }
        .chat-contact:hover { background-color: #e2e6ea; }
        .chat-contact.active { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        
        .chat-area { width: 65%; display: flex; flex-direction: column; background-color: #fff; }
        .chat-header { padding: 15px; background: #f1f1f1; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #fafafa; }
        
        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .message.received { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #eee; }
        .message.sent { background-color: #d1e7dd; align-self: flex-end; border-bottom-right-radius: 4px; color: #0f5132; }
        
        .message-time { display: block; font-size: 0.75em; margin-top: 4px; text-align: right; opacity: 0.7; }
        
        .chat-input-area { padding: 20px; border-top: 1px solid #ddd; display: flex; background: #fff; gap: 10px; }
        .chat-input-area input { flex-grow: 1; margin: 0; border-radius: 25px; padding: 12px 20px; border: 1px solid #ccc; }
        .chat-input-area button { margin: 0; border-radius: 25px; padding: 0 30px; height: 42px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Docente</h3>
        <a href="#avisos">Publicar Avisos</a>
        <a href="#observaciones">Observaciones Alumnos</a>
        <a href="#calificaciones">Subir Calificaciones</a>
        <a href="#asistencias">Registrar Asistencias</a>
        <a href="#evidencias">Subir Evidencias</a>
        <a href="#citas">Gestionar Citas</a>
        <a href="#chat">Chat con Tutores</a>
        <a href="#" onclick="logout()">Cerrar Sesi√≥n</a>
    </div>

    <div class="main-content">
        <h2 id="welcomeMessageDocente">Bienvenido, Docente</h2>

        <!-- AVISOS -->
        <div id="avisos" class="section">
            <h3>Publicar Avisos Generales</h3>
            <label><strong>T√≠tulo del Aviso:</strong></label>
            <input type="text" placeholder="Ej: Suspensi√≥n de clases...">
            <label><strong>Contenido:</strong></label>
            <textarea rows="4" placeholder="Escriba aqu√≠ el detalle del aviso..."></textarea>
            <button>Publicar Aviso</button>
        </div>

        <!-- OBSERVACIONES -->
        <div id="observaciones" class="section">
            <h3>Subir Observaciones del Alumno</h3>
            <label><strong>Seleccionar Alumno:</strong></label>
            <select><option value="">-- Selecciona un alumno --</option></select>
            <label><strong>T√≠tulo:</strong></label>
            <input type="text" placeholder="Ej: Comportamiento...">
            <label><strong>Descripci√≥n:</strong></label>
            <textarea rows="3"></textarea>
            <label><strong>Fecha y Hora:</strong></label>
            <input type="datetime-local" id="observacionDate">
            <button>Guardar Observaci√≥n</button>
        </div>

        <!-- CALIFICACIONES (MODIFICADO: MATERIAS AGREGADAS) -->
        <div id="calificaciones" class="section">
            <h3>Subir Calificaciones</h3>
            <div style="margin-bottom: 15px;">
                <label><strong>Seleccionar Alumno:</strong></label>
                <select id="selectAlumnoGrade"><option value="">-- Cargando alumnos... --</option></select>
            </div>
            <table class="styled-table">
                <thead><tr><th>Materia</th><th>1er Parcial</th><th>2do Parcial</th><th>3er Parcial</th><th>Promedio</th><th>Acciones</th></tr></thead>
                <tbody id="gradesBody">
                    <!-- Fila Matem√°ticas (ID 1) -->
                    <tr><td><strong>Matem√°ticas</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 1)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                    <!-- Fila Espa√±ol (ID 2) - AGREGADA -->
                    <tr><td><strong>Espa√±ol</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 2)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                    <!-- Fila Ciencias (ID 3) - AGREGADA -->
                    <tr><td><strong>Ciencias</strong></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><input type="number" min="0" max="10" step="0.1" oninput="calculateRow(this)"></td>
                        <td><span class="avg-display">-</span></td>
                        <td><button onclick="guardarNota(this, 3)" style="padding: 5px 10px; font-size: 12px; margin: 0;">Guardar</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ASISTENCIAS (MODIFICADO: TABLA MASIVA) -->
        <div id="asistencias" class="section">
            <h3>Registrar Asistencias del D√≠a</h3>
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                <label style="margin:0;">Fecha:</label>
                <input type="date" id="asistenciaFecha" style="width: auto; margin:0;">
            </div>
            
            <table class="styled-table" id="tablaAsistenciaMasiva">
                <thead>
                    <tr>
                        <th style="width: 40%;">Alumno</th>
                        <th style="width: 20%;">D√≠a</th>
                        <th style="width: 40%;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3">Cargando lista de alumnos...</td></tr>
                </tbody>
            </table>
            <button onclick="guardarAsistenciaMasiva()">Guardar Todo</button>
        </div>

        <!-- EVIDENCIAS (MODIFICADO: INPUTS Y MATERIA) -->
        <div id="evidencias" class="section">
            <h3>üì∑ Subir Evidencias de Clase</h3>
            <label><strong>Asignar a:</strong></label>
            <select><option value="all">Todo el Grupo</option></select>
            
            <!-- Campo Materia Agregado -->
            <label><strong>Materia:</strong></label>
            <select id="evidenciaMateria">
                <option value="1">Matem√°ticas</option>
                <option value="2">Espa√±ol</option>
                <option value="3">Ciencias</option>
            </select>

            <label><strong>T√≠tulo de la Evidencia:</strong></label>
            <input type="text" placeholder="Ej: Proyecto final...">
            
            <label><strong>Descripci√≥n:</strong></label>
            <textarea rows="3" placeholder="Detalles de la tarea..."></textarea>
            
            <!-- Input File Agregado -->
            <label><strong>Adjuntar Archivo (Foto/PDF):</strong></label>
            <input type="file" id="evidenciaFile">

            <button>üì§ Publicar Evidencia</button>
        </div>

        <!-- CITAS -->
        <div id="citas" class="section">
            <h3>Gestionar Citas</h3>
            <div style="margin-bottom: 30px;">
                <h4 style="color: #0056b3; border-bottom: 2px solid #e9ecef;">üîî Solicitudes</h4>
                <ul class="request-list"><li>Cargando...</li></ul>
            </div>
        </div>

        <!-- CHAT (MODIFICADO: LISTA DE TUTORES Y HORA) -->
        <div id="chat" class="section">
            <h3>Mensajer√≠a con Padres de Familia</h3>
            <div class="chat-container">
                <div class="chat-sidebar-list" id="listaTutoresChat">
                    <!-- Aqu√≠ se cargar√°n los tutores -->
                    <div style="padding:20px; color:#666;">Cargando contactos...</div>
                </div>
                <div class="chat-area">
                    <div class="chat-header" id="chatHeader">Selecciona un chat</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="msgInput" placeholder="Escriba un mensaje..." disabled>
                        <button onclick="sendMessage()" id="btnSend" disabled>Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Variable global para saber con qu√© tutor estamos hablando
        let currentChatTutorId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const userName = localStorage.getItem('loggedInUserName');
            const userId = localStorage.getItem('loggedInUserId'); 
            if (!userId) { window.location.href = 'login.html'; return; }
            if (userName) document.getElementById('welcomeMessageDocente').textContent = `Bienvenido, ${userName}`;

            // Fechas por defecto
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            if(document.getElementById('asistenciaFecha')) document.getElementById('asistenciaFecha').value = dateStr;
            if(document.getElementById('observacionDate')) {
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('observacionDate').value = now.toISOString().slice(0, 16);
            }

            cargarAlumnos(userId);
            cargarCitasPendientes(userId);
            cargarListaTutoresParaChat(userId);
            
            // Polling para el chat
            setInterval(() => {
                if(currentChatTutorId) cargarMensajesChat(userId, currentChatTutorId);
            }, 5000);
        });

        // 1. CARGAR ALUMNOS (LLENA SELECTS Y TABLA ASISTENCIA)
        async function cargarAlumnos(userId) {
            try {
                const res = await fetch(`/api/docente/alumnos/${userId}`);
                const alumnos = await res.json();
                
                // Llenar selects simples
                const selects = [document.getElementById('selectAlumnoGrade'), document.querySelector('#observaciones select')];
                selects.forEach(sel => {
                    sel.innerHTML = '<option value="">-- Selecciona un alumno --</option>';
                    alumnos.forEach(al => {
                        const opt = document.createElement('option');
                        opt.value = al.ID_Alumno; opt.textContent = `${al.Nombre_Alumno}`; sel.appendChild(opt);
                    });
                });
                
                // Llenar select Evidencias
                const selEvi = document.querySelector('#evidencias select');
                selEvi.innerHTML = '<option value="all">Todo el Grupo</option>';
                alumnos.forEach(al => {
                    const opt = document.createElement('option'); opt.value = al.ID_Alumno; opt.textContent = al.Nombre_Alumno; selEvi.appendChild(opt);
                });

                // LLENAR TABLA DE ASISTENCIA MASIVA
                const tablaAsis = document.querySelector('#tablaAsistenciaMasiva tbody');
                tablaAsis.innerHTML = '';
                if(alumnos.length === 0) {
                    tablaAsis.innerHTML = '<tr><td colspan="3">No hay alumnos asignados.</td></tr>';
                } else {
                    alumnos.forEach(al => {
                        const tr = document.createElement('tr');
                        // La fecha es visual, ya que se tomar√° del input global al guardar
                        tr.innerHTML = `
                            <td style="text-align:left; padding-left:20px;">${al.Nombre_Alumno}</td>
                            <td class="fecha-celda">--</td> 
                            <td>
                                <select class="estado-asistencia" data-id-alumno="${al.ID_Alumno}">
                                    <option value="presente">Presente</option>
                                    <option value="retardo">Retardo</option>
                                    <option value="ausente">Ausente</option>
                                </select>
                            </td>
                        `;
                        tablaAsis.appendChild(tr);
                    });
                    // Actualizar visualmente la fecha en las filas
                    actualizarFechaTabla();
                    document.getElementById('asistenciaFecha').addEventListener('change', actualizarFechaTabla);
                }

            } catch (e) { console.error(e); }
        }

        function actualizarFechaTabla() {
            const fecha = document.getElementById('asistenciaFecha').value;
            document.querySelectorAll('.fecha-celda').forEach(td => td.textContent = fecha);
        }

        // 2. GUARDAR ASISTENCIA MASIVA
        window.guardarAsistenciaMasiva = async () => {
            const fecha = document.getElementById('asistenciaFecha').value;
            const selects = document.querySelectorAll('.estado-asistencia');
            
            if(!confirm(`¬øGuardar asistencia para ${selects.length} alumnos con fecha ${fecha}?`)) return;

            // Enviamos uno por uno (limitaci√≥n del backend actual)
            // Idealmente el backend deber√≠a aceptar un array.
            let errores = 0;
            for(const sel of selects) {
                const idAlumno = sel.getAttribute('data-id-alumno');
                const estado = sel.value;
                try {
                    await fetch('/api/docente/asistencia', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ fecha, estado, idAlumno })
                    });
                } catch(e) { errores++; }
            }

            if(errores === 0) alert("Asistencias guardadas correctamente.");
            else alert("Hubo errores al guardar algunas asistencias.");
        };

        // 3. CALIFICACIONES (Actualizado para m√∫ltiples materias)
        window.calculateRow = function(input) { 
            const row = input.closest('tr'); const inputs = row.querySelectorAll('input[type="number"]');
            let s=0, c=0; inputs.forEach(i=>{if(i.value){s+=parseFloat(i.value); c++}});
            row.querySelector('.avg-display').textContent = c===3?(s/3).toFixed(1):"-";
        };

        window.guardarNota = async (boton, idMateria) => {
            const row = boton.closest('tr'); const inputs = row.querySelectorAll('input[type="number"]');
            const idAlumno = document.getElementById('selectAlumnoGrade').value;
            if (!idAlumno) return alert("Selecciona alumno");
            
            let guardados = 0;
            for (let i=0; i<3; i++) {
                if (inputs[i].value) {
                    await fetch('/api/docente/calificar', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ calificacion: inputs[i].value, parcial: (i+1).toString(), idAlumno, idMateria, idDocente: localStorage.getItem('loggedInUserId') })
                    });
                    guardados++;
                }
            }
            if(guardados > 0) alert("Notas guardadas para esta materia.");
            else alert("Ingresa al menos una nota.");
        };

       // 4. SUBIR EVIDENCIA (VERSI√ìN FINAL CON ARCHIVOS REALES)
document.querySelector('#evidencias button').addEventListener('click', async () => {
    const idAlumno = document.querySelector('#evidencias select').value;
    const idMateria = document.getElementById('evidenciaMateria').value;
    const titulo = document.querySelector('#evidencias input[type="text"]').value;
    const desc = document.querySelector('#evidencias textarea').value;
    const fileInput = document.getElementById('evidenciaFile');

    if(!titulo) return alert("El t√≠tulo es obligatorio");

    // CREAMOS UN FORM DATA PARA ENVIAR ARCHIVOS
    const formData = new FormData();
    formData.append('titulo', titulo);
    formData.append('descripcion', desc);
    formData.append('idMateria', idMateria);
    formData.append('idAlumno', idAlumno);
    
    // Si hay archivo, lo agregamos
    if(fileInput.files.length > 0) {
        formData.append('archivo', fileInput.files[0]);
    }

    try {
        const res = await fetch('/api/docente/evidencia', {
            method: 'POST',
            // NOTA: Cuando usas FormData, NO debes poner Content-Type header manualmente
            body: formData 
        });
        const data = await res.json();
        if(data.success) {
            alert("Evidencia publicada correctamente.");
            document.querySelector('#evidencias input[type="text"]').value=''; 
            document.querySelector('#evidencias textarea').value='';
            fileInput.value = '';
        } else {
            alert("Error al subir: " + data.msg);
        }
    } catch (e) {
        console.error(e);
        alert("Error de conexi√≥n");
    }
});
        // 5. CITAS (SIN CAMBIOS MAYORES)
        async function cargarCitasPendientes(userId) {
            const lista = document.querySelector('.request-list');
            const res = await fetch(`/api/docente/citas-pendientes/${userId}`);
            const citas = await res.json();
            lista.innerHTML = '';
            if(citas.length === 0) { lista.innerHTML = '<li>No hay solicitudes pendientes.</li>'; return; }

            citas.forEach(cita => {
                const fechaOriginal = new Date(cita.FechaSolicitud_Cita).toISOString().split('T')[0];
                const horaOriginal = cita.HoraSolicitada_Cita.substring(0,5);
                lista.innerHTML += `<li><strong>Tutor: ${cita.Nombre_Tutor}</strong><br><span class="request-meta">Solicita: ${fechaOriginal} - ${horaOriginal}</span><br><em>"${cita.Motivo_Cita}"</em><div style="margin-top:15px;"><button onclick="responderCita(${cita.ID_Cita}, 'Confirmada', '${fechaOriginal}', '${horaOriginal}')">Aceptar</button><button class="cancel" onclick="responderCita(${cita.ID_Cita}, 'Rechazada', null, null)">Rechazar</button></div></li>`;
            });
        }
        window.responderCita = async (idCita, estado, fecha, hora) => {
            if(!confirm(`¬øEst√°s seguro de marcar esta cita como: ${estado}?`)) return;
            await fetch('/api/docente/responder-cita', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idCita, estado, fecha, hora }) });
            alert("Cita actualizada"); cargarCitasPendientes(localStorage.getItem('loggedInUserId'));
        };

        // 6. CHAT MEJORADO (LISTA DE TUTORES Y TIMESTAMP)
        async function cargarListaTutoresParaChat(userId) {
            const sidebar = document.getElementById('listaTutoresChat');
            const res = await fetch(`/api/docente/tutores/${userId}`); 
            const tutores = await res.json();
            
            sidebar.innerHTML = '';
            if(tutores.length === 0) sidebar.innerHTML = '<div style="padding:20px;">No hay tutores asignados.</div>';

            tutores.forEach(t => {
                const div = document.createElement('div');
                div.className = 'chat-contact';
                div.innerHTML = `<strong>${t.Nombre_Tutor}</strong><br><small>Alumno: ${t.Nombre_Alumno}</small>`;
                div.onclick = () => abrirChat(t.ID_Tutor, t.Nombre_Tutor, div);
                sidebar.appendChild(div);
            });
        }

        function abrirChat(idTutor, nombreTutor, elementoDiv) {
            currentChatTutorId = idTutor;
            document.getElementById('chatHeader').textContent = `Chat con: ${nombreTutor}`;
            
            // UI Active
            document.querySelectorAll('.chat-contact').forEach(d => d.classList.remove('active'));
            elementoDiv.classList.add('active');

            // Habilitar inputs
            document.getElementById('msgInput').disabled = false;
            document.getElementById('btnSend').disabled = false;

            cargarMensajesChat(localStorage.getItem('loggedInUserId'), idTutor);
        }

        async function cargarMensajesChat(idDocente, idTutor) {
            const div = document.querySelector('.chat-messages');
            // Usamos el endpoint existente, pasando idDestinatario como si fuera el del filtro
            // Nota: El endpoint original trae TODOS los mensajes del docente. 
            // Para filtrarlo por tutor correctamente, lo haremos aqu√≠ en JS si el backend no filtra.
            
            const res = await fetch('/api/chat/mensajes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idUsuario: idDocente, rol: 'Docente' }) });
            const todosLosMensajes = await res.json();
            
            // Filtramos solo los mensajes de este tutor (ID_MnsjTutor == idTutor)
            const mensajesFiltrados = todosLosMensajes.filter(m => m.ID_MnsjTutor == idTutor);

            div.innerHTML = '';
            mensajesFiltrados.forEach(m => {
                // Determinar si es enviado o recibido
                // Si RemitenteNombre es el tutor, entonces es RECIBIDO.
                // Pero el endpoint devuelve "RemitenteNombre" gen√©rico. 
                // Mejor l√≥gica: Si ID_MnsjTutor == idTutor (siempre true por el filtro) necesitamos saber la direcci√≥n.
                // Asumimos que la BD no tiene campo "EnviadoPor", as√≠ que deducimos:
                // El backend actual solo guarda mensajes. Falta un campo de "Qui√©n lo envi√≥".
                // TRUCO TEMPORAL BASADO EN TU BACKEND:
                // Tu backend actual NO guarda qui√©n envi√≥ el mensaje (flag), solo el ID de Docente y Tutor.
                // Asumir√© que si el mensaje tiene texto, lo mostramos.
                // *Correcci√≥n:* Como no puedo cambiar la BD, no puedo saber 100% qui√©n lo envi√≥ sin ese campo.
                // Asumir√© que todos se alinean a la izquierda a menos que yo lo acabe de enviar.
                // (Para corregir esto real, necesitas agregar un campo 'EnviadoPor' en la tabla Mensajes en tu SQL).
                
                // Por ahora, mostrar√© todos alineados a la izquierda con el nombre del remitente si viene del Tutor.
                
                // Simulacion visual basada en la estructura:
                // Si el mensaje viene del Tutor (Nombre en el objeto), es recibido.
                const esMio = false; // Sin campo en BD, es dif√≠cil saber. Lo dejaremos como "Recibido" por defecto.
                
                const fecha = new Date(m.Fecha_Mnsj);
                const hora = fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Como el endpoint del docente hace JOIN con Tutores, 'RemitenteNombre' es el Tutor.
                // Si el mensaje lo envi√≥ el tutor, sale su nombre. Si lo envi√© yo, ¬øqu√© sale?
                // Tu backend: `SELECT M.*, T.Nombre_Tutor as RemitenteNombre ...`
                // Esto significa que SIEMPRE traer√° el nombre del Tutor. Es una limitante del backend actual.
                // LO HAREMOS VISUALMENTE "NEUTRO" O ASUMIREMOS QUE TODO LO QUE LLEGA ES DEL TUTOR
                // HASTA QUE ENVIES UNO T√ö.
                
                div.innerHTML += `
                    <div class="message received">
                        ${m.Contenido_Mnsj}
                        <span class="message-time">${hora}</span>
                    </div>`;
            });
        }

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput');
            if(!inp.value || !currentChatTutorId) return;
            
            await fetch('/api/chat/enviar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    contenido: inp.value, 
                    idUsuario: localStorage.getItem('loggedInUserId'), 
                    rol: 'Docente', 
                    idDestinatario: currentChatTutorId 
                })
            });

            // Agregar visualmente el mensaje como "Enviado" (Verde/Derecha)
            const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.querySelector('.chat-messages').innerHTML += `
                <div class="message sent">
                    ${inp.value}
                    <span class="message-time">${hora}</span>
                </div>`;
            
            inp.value = '';
            // Scroll al fondo
            const d = document.querySelector('.chat-messages');
            d.scrollTop = d.scrollHeight;
        };

        window.logout = function() { localStorage.clear(); window.location.href='pagina inicio logo.html'; }
    </script>
</body>
</html>